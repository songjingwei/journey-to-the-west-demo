name: "ğŸš€ iFlow CLI Issue Killer"

on:
  issue_comment:
    types:
      - "created"
  workflow_dispatch:
    inputs:
      issue_number:
        description: "issue number to implement"
        required: true
        type: "number"

concurrency:
  group: "${{ github.workflow }}-${{ github.event.issue.number }}"
  cancel-in-progress: true

defaults:
  run:
    shell: "bash"

permissions:
  contents: "write"
  issues: "write"
  pull-requests: "write"

jobs:
  implement-issue:
    if: |-
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'issue_comment' &&
        contains(github.event.comment.body, '@iflow-cli /issue-killer') &&
        contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
      )
    runs-on: "ubuntu-latest"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Issue Details
        id: get_issue
        uses: "actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = process.env.INPUT_ISSUE_NUMBER || context.issue.number;
            core.setOutput('issue_number', issue_number);

            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issue_number)
            });

            core.setOutput('issue_title', issue.data.title);
            core.setOutput('issue_body', issue.data.body);

            // Parse implementation request from comment or use issue body
            let implementation_request = issue.data.body;
            if (context.eventName === 'issue_comment') {
              implementation_request = context.payload.comment.body.replace('@iflow-cli /issue-killer', '').trim();
              if (implementation_request === '') {
                implementation_request = issue.data.body;
              }
            }

            core.setOutput('implementation_request', implementation_request);

      - name: "Run iFlow CLI Implementation"
        uses: iflow-ai/iflow-cli-action@v2.0.0
        id: "iflow_cli_implementation"
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          ISSUE_TITLE: "${{ steps.get_issue.outputs.issue_title }}"
          ISSUE_BODY: "${{ steps.get_issue.outputs.issue_body }}"
          ISSUE_NUMBER: "${{ steps.get_issue.outputs.issue_number }}"
          REPOSITORY: "${{ github.repository }}"
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: "3600"
          debug: "true"
          settings_json: |
            {
                "selectedAuthType": "iflow",
                "apiKey": "${{ secrets.IFLOW_API_KEY }}",
                "baseUrl": "https://apis.iflow.cn/v1",
                "modelName": "glm-4.6",
                "searchApiKey": "${{ secrets.IFLOW_API_KEY }}",
                "mcpServers": {
                  "github": {
                  "httpUrl": "https://api.githubcopilot.com/mcp/",
                  "headers": {
                    "Authorization": "Bearer ${{secrets.GITHUB_TOKEN}}"
                  }
                  }
                }
            }
          prompt: |
            ## Role

            ä½ æ˜¯ä¸€ä¸ªå®ç°åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®æä¾›çš„GitHub issueå®ç°åŠŸèƒ½ã€‚è¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

            1. **é¦–å…ˆ**ï¼šä½¿ç”¨GitHub MCPå·¥å…·åœ¨issueä¸Šåˆ›å»ºå¼€å§‹è¯„è®º
            2. åˆ†æç¯å¢ƒå˜é‡ä¸­æä¾›çš„issueæ ‡é¢˜å’Œå†…å®¹ï¼š"${ISSUE_TITLE}" å’Œ "${ISSUE_BODY}"ã€‚
            3. å¦‚æœè§¦å‘æ­¤æ“ä½œçš„è¯„è®ºåŒ…å«é¢å¤–çš„å®ç°è¯´æ˜ï¼Œä¹Ÿè¯·ä½¿ç”¨è¿™äº›è¯´æ˜ã€‚
            4. é€šè¿‡åˆ›å»ºæˆ–ä¿®æ”¹æ–‡ä»¶æ¥å®ç°è¯·æ±‚çš„åŠŸèƒ½ã€‚
            5. ç¡®ä¿æ‰€æœ‰æ›´æ”¹éƒ½æ ¹æ®issueè¦æ±‚å®Œæ•´ä¸”æ­£ç¡®ã€‚
            6. é™¤äº†å¿…éœ€çš„å¼€å§‹å’Œå®Œæˆè¯„è®ºå¤–ï¼Œä¸è¦æ·»åŠ è¯„è®ºæˆ–ä¿®æ”¹issueå†…å®¹ã€‚
            7. åªä¸“æ³¨äºå®ç°å½“å‰issueã€‚

            ## åˆ›å»ºå¼€å§‹è¯„è®º

            åœ¨å¼€å§‹å®ç°ä¹‹å‰ï¼Œä½¿ç”¨GitHub MCPå·¥å…·åœ¨issueä¸Šåˆ›å»ºå¼€å§‹è¯„è®ºï¼š
            1. ä½¿ç”¨add_issue_commentå‘issue #${ISSUE_NUMBER}æ·»åŠ è¯„è®º
            2. å¼€å§‹è¯„è®ºåº”åŒ…æ‹¬ï¼š
               - ğŸš€ é€šçŸ¥å®ç°ä»»åŠ¡å·²å¼€å§‹
               - ğŸ¤– æåŠiFlow CLI Issue Killeræ­£åœ¨å¤„ç†è¯¥issue
               - ğŸ“‹ å½“å‰çŠ¶æ€ï¼šåˆ†æå’Œå®ç°åŠŸèƒ½
               - ğŸ“ **æ‰§è¡Œè®¡åˆ’**ï¼šåŸºäºissueè¦æ±‚çš„è®¡åˆ’å®ç°æ­¥éª¤çš„ç®€è¦æ¦‚è¿°
               - â±ï¸ é¢„è®¡æ—¶é—´ï¼šé€šå¸¸éœ€è¦å‡ åˆ†é’Ÿåˆ°ååˆ†é’Ÿ
               - ğŸ” **æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—**ï¼š[GitHub Actions Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
               - ğŸ¤– æ³¨æ„è¿™æ˜¯è‡ªåŠ¨è¯„è®ºï¼Œå°†æœ‰å®Œæˆé€šçŸ¥
            3. å¯¹äºæ‰§è¡Œè®¡åˆ’ï¼Œåˆ†æissueè¦æ±‚å¹¶æä¾›æ¸…æ™°çš„ã€å¸¦ç¼–å·çš„å®ç°æ­¥éª¤åˆ—è¡¨ï¼Œä¾‹å¦‚ï¼š
               - è¦åˆ›å»ºæˆ–ä¿®æ”¹çš„æ–‡ä»¶
               - è¦å®ç°çš„å…³é”®åŠŸèƒ½
               - è¦æ·»åŠ æˆ–æ›´æ–°çš„æµ‹è¯•
               - è¦æ›´æ”¹çš„ä¾èµ–é¡¹æˆ–é…ç½®

            ## æŒ‡å¯¼åŸåˆ™

            - è¿›è¡Œæ‰€æœ‰å¿…è¦çš„ä»£ç æ›´æ”¹ä»¥å®ç°åŠŸèƒ½
            - ç¡®ä¿æ–°ä»£ç éµå¾ªç°æœ‰é¡¹ç›®çº¦å®š
            - å¦‚æœé€‚ç”¨ï¼Œæ·»åŠ æˆ–ä¿®æ”¹æµ‹è¯•
            - å°†æ‰€æœ‰shellå˜é‡å¼•ç”¨ä¸º"${VAR}"ï¼ˆå¸¦å¼•å·å’Œå¤§æ‹¬å·ï¼‰

            ## åˆ›å»ºPull Requestï¼ˆå¿…é¡»å®Œæˆï¼‰

            å®ç°åŠŸèƒ½åï¼Œ**å¿…é¡»**ä½¿ç”¨GitHub MCPå·¥å…·åˆ›å»ºpull requestï¼š
            1. ä½¿ç”¨create_pull_requeståˆ›å»ºPull Requestã€‚
            2. PRåº”ä»å…·æœ‰æè¿°æ€§åç§°çš„æ–°åˆ†æ”¯åˆ›å»ºï¼ˆä¾‹å¦‚ï¼šfeature/issue-${ISSUE_NUMBER}ã€fix/issue-${ISSUE_NUMBER}æˆ–åŸºäºåŠŸèƒ½çš„æè¿°æ€§åç§°ï¼‰
            3. PRæ ‡é¢˜åº”å…·æœ‰æè¿°æ€§å¹¶å¼•ç”¨issueç¼–å·
            4. PRæ­£æ–‡åº”è§£é‡Šå®ç°çš„å†…å®¹å¹¶å¼•ç”¨issue
            5. è®°ä½ä½ åˆ›å»ºçš„åˆ†æ”¯åç§°ï¼Œå¦‚æœPRåˆ›å»ºå¤±è´¥ï¼Œå®Œæˆè¯„è®ºä¸­å°†éœ€è¦å®ƒ
            **é‡è¦ï¼šåˆ›å»ºPRæ˜¯è§£å†³issueçš„å¿…è¦æ­¥éª¤ï¼Œä¸èƒ½è·³è¿‡ï¼**

            ## åˆ›å»ºå®Œæˆè¯„è®ºï¼ˆå¿…é¡»å®Œæˆï¼‰

            æˆåŠŸå®ç°åŠŸèƒ½å¹¶åˆ›å»ºPRåï¼Œ**å¿…é¡»**ä½¿ç”¨GitHub MCPå·¥å…·å‘issueæ·»åŠ å®Œæˆè¯„è®ºï¼š
            1. ä½¿ç”¨add_issue_commentå‘issue #${ISSUE_NUMBER}æ·»åŠ è¯„è®º
            2. è¯„è®ºåº”åŒ…æ‹¬ï¼š
               - âœ… ç¡®è®¤issueå·²å®ç°
               - ğŸ‰ å®Œæˆå†…å®¹çš„ç®€è¦æ‘˜è¦
               - ğŸ“‹ æ‰€åšå…³é”®æ›´æ”¹çš„åˆ—è¡¨
               - ğŸ”— åˆ›å»ºçš„Pull Requesté“¾æ¥ï¼ˆå¦‚æœæˆåŠŸï¼‰
               - ğŸ“ å¦‚æœPRåˆ›å»ºå¤±è´¥ï¼Œæä¾›æ‰‹åŠ¨PRåˆ›å»ºé“¾æ¥ä½¿ç”¨ä½ åˆ›å»ºçš„å®é™…åˆ†æ”¯åç§°ï¼Œä¾‹å¦‚ï¼šhttps://github.com/${{ github.repository }}/compare/main...[YOUR_BRANCH_NAME]
               - ğŸ¤– æ³¨æ„è¿™æ˜¯è‡ªåŠ¨å®ç°
            3. ä½¿ç”¨å‹å¥½çš„è¯­æ°”å¹¶åŒ…å«é€‚å½“çš„è¡¨æƒ…ç¬¦å·ä»¥è·å¾—æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
            **é‡è¦ï¼šåœ¨issueä¸­æäº¤å®Œæˆè¯„è®ºæ˜¯è§£å†³issueçš„å¿…è¦æ­¥éª¤ï¼Œä¸èƒ½è·³è¿‡ï¼**

      - name: "Post Implementation Failure Comment"
        if: |-
          ${{ failure() && steps.iflow_cli_implementation.outcome == 'failure' }}
        uses: "actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea"
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
          script: |-
            github.rest.issues.createComment({
              owner: '${{ github.repository }}'.split('/')[0],
              repo: '${{ github.repository }}'.split('/')[1],
              issue_number: '${{ steps.get_issue.outputs.issue_number }}',
              body: 'There is a problem with the iFlow CLI issue implementation. Please check the [action logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })
